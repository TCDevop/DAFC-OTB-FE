# Deploy Next.js standalone to Azure App Service
# Single-job workflow: build + deploy in one step to avoid artifact hidden-file issues

name: Build and deploy Node.js app to Azure Web App - VibeAppFE

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js standalone
        run: npm run build
        env:
          NODE_ENV: production

      # After build + postbuild, .next/standalone/ contains:
      #   server.js, node_modules/, .next/ (build artifacts), public/, .next/static/
      # We deploy the CONTENTS of .next/standalone/ directly to Azure wwwroot

      - name: Prepare deployment package
        run: |
          mkdir deploy

          # Copy standalone contents to deploy folder
          cp -a .next/standalone/. deploy/

          # Override package.json start script for Azure
          # (Azure runs "npm start" â†’ must point to "node server.js" since server.js is at root)
          node -e "
            const pkg = require('./package.json');
            pkg.scripts.start = 'node server.js';
            require('fs').writeFileSync('./deploy/package.json', JSON.stringify(pkg, null, 2));
          "

          # Verify deployment package
          echo "=== deploy/ contents ==="
          ls -la deploy/
          echo "=== .next/ build artifacts ==="
          ls -la deploy/.next/
          echo "=== BUILD_ID ==="
          cat deploy/.next/BUILD_ID

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'VibeAppFE'
          slot-name: 'Production'
          package: deploy
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_88CE067C4BE34BACBBC4F1C1D281EEF5 }}
